import os
import requests
import asyncio
from datetime import datetime
from telegram import Bot
import random
import traceback
import re
import html

class FreeAITechAgent:
    def __init__(self):
        self.bot = Bot(token=os.environ["TELEGRAM_BOT_TOKEN"])
        self.user_id = os.environ["TELEGRAM_USER_ID"]  # –í–∞—à –ª–∏—á–Ω—ã–π ID –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å—Ç–∞
        self.unsplash_key = os.environ["UNSPLASH_ACCESS_KEY"]
        self.reddit_headers = {"User-agent": "AITechBot/1.0"}
        
        # –°–ª—É—á–∞–π–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
        self.categories = ["–Ω–æ–≤–∏–Ω–∫–∏", "–ø—Ä–∏—ë–º—ã", "–∏–Ω—Å–∞–π–¥—ã", "–º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è", "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", "–¥–æ—Å—Ç—É–ø"]
        self.category = random.choice(self.categories)
    
    async def fetch_reddit_posts(self):
        """–ü–∞—Ä—Å–∏–º –∫–µ–π—Å—ã –ø–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏—é"""
        posts = []
        subreddits = [
            ("r/StableDiffusion", "–≥–µ–Ω–µ—Ä–∞—Ü–∏—è"),
            ("r/sidehustle", "–∑–∞—Ä–∞–±–æ—Ç–æ–∫"),
            ("r/Midjourney", "–ø—Ä–æ–º–ø—Ç—ã"),
            ("r/ArtificialIntelligence", "–Ω–æ–≤–æ—Å—Ç–∏ –ò–ò")
        ]
        
        for subreddit, niche in subreddits:
            try:
                url = f"https://www.reddit.com/{subreddit}/top.json?t=week&limit=10"
                response = requests.get(url, headers=self.reddit_headers, timeout=10)
                data = response.json()
                
                for post in data["data"]["children"]:
                    title = post["data"]["title"]
                    score = post["data"]["score"]
                    if score < 80:
                        continue
                    if any(word in title.lower() for word in ["crypto", "nft", "bitcoin", "scam"]):
                        continue
                    if len(title) < 40:
                        continue
                    posts.append({
                        "title": title,
                        "subreddit": subreddit,
                        "score": score
                    })
            except:
                continue
        
        posts.sort(key=lambda x: x["score"], reverse=True)
        return posts[:3]
    
    async def generate_text(self, reddit_posts=None):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ—Å—Ç –ø–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏—é"""
        
        # –¢–µ–º—ã –ø–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        topics_by_category = {
            "–Ω–æ–≤–∏–Ω–∫–∏": [
                "–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π",
                "–≤—ã—à–µ–ª –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∞–Ω–∞–ª–æ–≥ –¥–æ—Ä–æ–≥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞",
                "–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –ò–ò-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞",
                "–Ω–æ–≤—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–µ–æ –±–µ–∑ –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤",
                "—Ä–µ–ª–∏–∑ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"
            ],
            "–ø—Ä–∏—ë–º—ã": [
                "–∫–∞–∫ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 100 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –¥–µ–Ω—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ",
                "–∫–∞–∫ –æ–±–æ–π—Ç–∏ –ª–∏–º–∏—Ç—ã –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤",
                "–∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç –±–µ–∑ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
                "–∫–∞–∫ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞",
                "–∫–∞–∫ —É—Å–∫–æ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
            ],
            "–∏–Ω—Å–∞–π–¥—ã": [
                "—Å–∫—Ä—ã—Ç—ã–µ —Ñ–∏—á–∏ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞",
                "–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–ª–∞—Ç–Ω—ã–º –º–æ–¥–µ–ª—è–º",
                "–∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –±–µ—Ç–∞-–¥–æ—Å—Ç—É–ø –∫ –Ω–æ–≤—ã–º —Å–µ—Ä–≤–∏—Å–∞–º",
                "—Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –∏–¥–µ–∞–ª—å–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π",
                "–∫–∞–∫ –æ–±–æ–π—Ç–∏ —Ü–µ–Ω–∑—É—Ä—É –≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞—Ö"
            ],
            "–º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è": [
                "–∫–∞–∫ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö",
                "–∫–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥–∞–∂–∏ –ø—Ä–æ–º–ø—Ç–æ–≤",
                "–∫–∞–∫ –≤—ã–±—Ä–∞—Ç—å –Ω–∏—à—É –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –ø—Ä–æ–º–ø—Ç–æ–≤",
                "–ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ò–ò-—Å–µ—Ä–≤–∏—Å–æ–≤",
                "–∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–±—Ä–∏–∫—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –ò–ò"
            ],
            "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã": [
                "–ø–æ–ª–Ω—ã–π –≥–∞–π–¥ –ø–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º—É –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—É",
                "–∫–∞–∫ –Ω–∞—á–∞—Ç—å —Å –ò–ò –±–µ–∑ –æ–ø—ã—Ç–∞",
                "—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ –≤–∏–¥–µ–æ",
                "–∫–∞–∫ –≤—ã–±—Ä–∞—Ç—å —Å–µ—Ä–≤–∏—Å –ø–æ–¥ —Å–≤–æ—é –∑–∞–¥–∞—á—É",
                "–ª–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ –ò–ò –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞"
            ],
            "–¥–æ—Å—Ç—É–ø": [
                "–∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–µ—Ä–≤–∏—Å–∞–º –ª–µ–≥–∞–ª—å–Ω–æ",
                "–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ò–ò-—Å–µ—Ä–≤–∏—Å—ã",
                "–∫–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å –±–µ–∑ –∫–∞—Ä—Ç—ã –†–§",
                "–±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –ø–ª–∞—Ç–Ω—ã–º —Å–µ—Ä–≤–∏—Å–∞–º",
                "–∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ò–ò —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏"
            ]
        }
        
        topic = random.choice(topics_by_category.get(self.category, topics_by_category["–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"]))
        
        # –≠–º–æ–¥–∑–∏ –ø–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        category_emoji = {
            "–Ω–æ–≤–∏–Ω–∫–∏": "üÜï",
            "–ø—Ä–∏—ë–º—ã": "üí°",
            "–∏–Ω—Å–∞–π–¥—ã": "üîí",
            "–º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è": "üí∞",
            "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã": "üõ†Ô∏è",
            "–¥–æ—Å—Ç—É–ø": "üåç"
        }
        emoji = category_emoji.get(self.category, "ü§ñ")
        
        prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ò–ò. –ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø–æ—Å—Ç—ã —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–ª—è Telegram.

–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {self.category}
–¢–µ–º–∞: {topic}

–°–¢–†–£–ö–¢–£–†–ê:
1. –ó–∞–≥–æ–ª–æ–≤–æ–∫: <b>{emoji} [–ö–æ—Ä–æ—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏—é]</b>
2. –û–ø–∏—Å–∞–Ω–∏–µ: 1 —Å—Ç—Ä–æ–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã/–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
3. –°–ø–∏—Å–æ–∫ –∏–∑ 3-4 –ø—É–Ω–∫—Ç–æ–≤:
   ‚Äî –ö–∞–∂–¥—ã–π —Å —ç–º–æ–¥–∑–∏
   ‚Äî –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ <b>–∂–∏—Ä–Ω–æ–º</b>
   ‚Äî –î–µ—Ç–∞–ª–∏ –≤ <i>–∫—É—Ä—Å–∏–≤–µ</i>
4. –¶–µ–Ω—ã/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
5. –°—Å—ã–ª–∫–∞: <a href="URL">–∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç</a>

–ü–†–ê–í–ò–õ–ê:
‚úÖ –¢–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã, –±–µ–∑ –∫–ª–∏–∫–±–µ–π—Ç–∞
‚úÖ –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—Ä–∞–∂–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é ({self.category})
‚úÖ –ú–∞–∫—Å–∏–º—É–º 850 —Å–∏–º–≤–æ–ª–æ–≤
‚úÖ –ù–∏–∫–∞–∫–∏—Ö "–ª–∞–π—Ñ—Ö–∞–∫–æ–≤", "–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ", "–±—Ä–∞—Ç–∞–Ω"
‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ <b>, <i>, <a>

–ü–†–ò–ú–ï–†:
<b>{emoji} –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏—é {self.category}</b>

–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.

–°–ø–∏—Å–æ–∫:
üñºÔ∏è <b>–°–µ—Ä–≤–∏—Å 1</b> ‚Äî <i>—á—Ç–æ –¥–∞—ë—Ç</i>
üé® <b>–°–µ—Ä–≤–∏—Å 2</b> ‚Äî <i>–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</i>
üöÄ <b>–°–µ—Ä–≤–∏—Å 3</b> ‚Äî <i>–∫–∞–∫ –Ω–∞—á–∞—Ç—å</i>

–¶–µ–Ω—ã:
‚Äî –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: –¥–æ –• –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
‚Äî –ü–ª–∞—Ç–Ω–æ: –æ—Ç $–•/–º–µ—Å

<a href="https://—Å–µ—Ä–≤–∏—Å.–∫–æ–º">–ù–∞—á–∞—Ç—å</a>"""

        try:
            response = requests.post(
                "https://api.groq.com/openai/v1/chat/completions",
                headers={
                    "Authorization": f"Bearer {os.environ['GROQ_API_KEY']}",
                    "Content-Type": "application/json"
                },
                json={
                    "model": "llama-3.1-70b-versatile",
                    "messages": [{"role": "user", "content": prompt}],
                    "max_tokens": 450,
                    "temperature": 0.75
                },
                timeout=35
            )
            
            if response.status_code != 200:
                return self._fallback_post()
            
            text = response.json()["choices"][0]["message"]["content"]
            return self._clean_html(text)
            
        except:
            return self._fallback_post()
    
    def _clean_html(self, text):
        """–û—á–∏—â–∞–µ–º HTML –¥–ª—è Telegram"""
        text = text.replace("**", "").replace("__", "").replace("```", "")
        text = html.escape(text, quote=False)
        text = re.sub(r'&lt;b&gt;(.*?)&lt;/b&gt;', r'<b>\1</b>', text)
        text = re.sub(r'&lt;i&gt;(.*?)&lt;/i&gt;', r'<i>\1</i>', text)
        text = re.sub(r'&lt;a href=&quot;(.*?)&quot;&gt;(.*?)&lt;/a&gt;', r'<a href="\1">\2</a>', text)
        text = re.sub(r'(?i)–ª–∞–π—Ñ—Ö–∞–∫[:\s]*', '', text)
        text = re.sub(r'(?i)–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ[:\s–∞-—è0-9]+', '', text)
        if len(text) > 850:
            text = text[:847] + "..."
        lines = [line.rstrip() for line in text.split("\n") if line.strip()]
        return "\n".join(lines[:22])
    
    def _fallback_post(self):
        """–§–æ–ª–±—ç–∫ –ø–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏—é"""
        fallbacks = {
            "–Ω–æ–≤–∏–Ω–∫–∏": """<b>üÜï –ù–æ–≤—ã–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –≤–∏–¥–µ–æ 2026</b>

–ü–æ—è–≤–∏–ª–∏—Å—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –¥–æ—Ä–æ–≥–∏–º —Å–µ—Ä–≤–∏—Å–∞–º.

–ß—Ç–æ –Ω–æ–≤–æ–≥–æ:
üé• <b>Pika 2.0</b> ‚Äî <i>–±–µ—Å–ø–ª–∞—Ç–Ω–æ 150 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π/–Ω–µ–¥–µ–ª—é</i>
üé¨ <b>LeiaPix</b> ‚Äî <i>–∞–Ω–∏–º–∞—Ü–∏—è —Ñ–æ—Ç–æ –∑–∞ 10 —Å–µ–∫—É–Ω–¥</i>
üöÄ <b>Runway Lite</b> ‚Äî <i>–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ –±–µ–∑ –≤–æ–¥—è–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤</i>

–¶–µ–Ω—ã:
‚Äî –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: –±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚Äî –ü–ª–∞—Ç–Ω–æ: –æ—Ç $15/–º–µ—Å –∑–∞ 4K

<a href="https://pika.art">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å Pika</a>""",
            "–ø—Ä–∏—ë–º—ã": """<b>üí° –ö–∞–∫ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 100 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –¥–µ–Ω—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</b>

–ù–µ –Ω—É–∂–Ω–æ –ø–ª–∞—Ç–∏—Ç—å $10 –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É.

–°—Ö–µ–º–∞:
üñºÔ∏è <b>Leonardo.ai</b> ‚Äî <i>150 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</i>
üé® <b>Playground AI</b> ‚Äî <i>1000 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/–¥–µ–Ω—å</i>
üöÄ <b>Bing Image Creator</b> ‚Äî <i>–±–µ–∑–ª–∏–º–∏—Ç —á–µ—Ä–µ–∑ –∞–∫–∫–∞—É–Ω—Ç</i>

–§–æ–∫—É—Å: —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –≤–æ –≤—Å–µ—Ö —Ç—Ä—ë—Ö ‚Äî –ø–æ–ª—É—á–∏—à—å 2000+ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –≤ –º–µ—Å—è—Ü.

<a href="https://leonardo.ai">–ù–∞—á–∞—Ç—å —Å Leonardo</a>""",
            "–∏–Ω—Å–∞–π–¥—ã": """<b>üîí –°–∫—Ä—ã—Ç–∞—è —Ñ–∏—á–∞ Leonardo.ai</b>

–ú–∞–ª–æ –∫—Ç–æ –∑–Ω–∞–µ—Ç –ø—Ä–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–ª–∞—Ç–Ω—ã–º –º–æ–¥–µ–ª—è–º.

–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å:
1. –ó–∞–π–¥–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
2. –í–∫–ª—é—á–∏ ¬´–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏¬ª
3. –ü–æ–ª—É—á–∏ –¥–æ—Å—Ç—É–ø –∫ SDXL Turbo –∏ Flux –±–µ—Å–ø–ª–∞—Ç–Ω–æ

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
‚Äî –¢–æ–ª—å–∫–æ 50 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π/–¥–µ–Ω—å
‚Äî –ù–æ –∫–∞—á–µ—Å—Ç–≤–æ –∫–∞–∫ —É –ø–ª–∞—Ç–Ω—ã—Ö

<a href="https://leonardo.ai">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</a>""",
            "–º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è": """<b>üí∞ –ö–∞–∫ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã –∏ –ø–æ–ª—É—á–∞—Ç—å $3-7 –∑–∞ —à—Ç—É–∫—É</b>

–ú–æ–Ω–µ—Ç–∏–∑–∏—Ä—É–π –Ω–∞–≤—ã–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –ò–ò –±–µ–∑ –≤–ª–æ–∂–µ–Ω–∏–π.

–ì–¥–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å:
‚Ä¢ <b>PromptBase</b> ‚Äî <i>–∫—Ä—É–ø–Ω–µ–π—à–∏–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</i>
‚Ä¢ <b>Telegram-–∫–∞–Ω–∞–ª—ã</b> ‚Äî <i>–ø—Ä—è–º—ã–µ –ø—Ä–æ–¥–∞–∂–∏</i>

–ö–∞–∫ –Ω–∞—á–∞—Ç—å:
1. –í—ã–±–µ—Ä–∏ —É–∑–∫—É—é –Ω–∏—à—É (–∫–æ—Ñ–µ–π–Ω–∏, –≤–µ—Ç–∫–ª–∏–Ω–∏–∫–∏)
2. –°–æ–∑–¥–∞–π 5-7 –ø—Ä–æ–º–ø—Ç–æ–≤
3. –°–¥–µ–ª–∞–π 3 –ø—Ä–∏–º–µ—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
4. –ó–∞–≥—Ä—É–∑–∏ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å

–†–µ–∞–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã (—Ñ–µ–≤—Ä–∞–ª—å 2026):
‚Äî –°—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥ –Ω–æ–≤–∏—á–∫–∞: $50-150 –∑–∞ 60 –¥–Ω–µ–π

<a href="https://promptbase.com">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã</a>""",
            "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã": """<b>üõ†Ô∏è Leonardo.ai ‚Äî –ø–æ–ª–Ω—ã–π –≥–∞–π–¥ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤</b>

–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫.

–ö–∞–∫ –Ω–∞—á–∞—Ç—å:
1. –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ <a href="https://leonardo.ai">leonardo.ai</a>
2. –ù–∞–∂–º–∏ ¬´Sign Up¬ª ‚Üí –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è —á–µ—Ä–µ–∑ Google
3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –ø–æ—á—Ç—É
4. –í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å ¬´Leonardo Diffusion XL¬ª
5. –ù–∞–ø–∏—à–∏ –ø—Ä–æ–º–ø—Ç ‚Üí –Ω–∞–∂–º–∏ ¬´Generate¬ª

–ë–µ—Å–ø–ª–∞—Ç–Ω–æ:
‚Äî 150 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
‚Äî –ü–æ—Ç–æ–º 5 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π/–¥–µ–Ω—å

–†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∫–∞—Ä—Ç—ã –∏ –±–µ–∑ VPN.

<a href="https://leonardo.ai">–ù–∞—á–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</a>""",
            "–¥–æ—Å—Ç—É–ø": """<b>üåç –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ò–ò-—Å–µ—Ä–≤–∏—Å–∞–º</b>

–õ–µ–≥–∞–ª—å–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–±—Ö–æ–¥–∞ –≥–µ–æ–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.

–°–ø–æ—Å–æ–±—ã:
üîê <b>Proton VPN</b> ‚Äî <i>–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞</i>
üåê <b>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∑–µ—Ä–∫–∞–ª–∞</b> ‚Äî <i>—á–µ—Ä–µ–∑ Cloudflare Workers</i>
üì± <b>–ë—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è</b> ‚Äî <i>Orbot –¥–ª—è Android</i>

–í–∞–∂–Ω–æ: VPN –ª–µ–≥–∞–ª–µ–Ω –≤ –†–§ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –æ–±—Ö–æ–¥–∞ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö –†–æ—Å–∫–æ–º–Ω–∞–¥–∑–æ—Ä–æ–º —Å–∞–π—Ç–æ–≤.

–†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è:
‚Äî Hugging Face Spaces
‚Äî Replicate.com
‚Äî Leonardo.ai

<a href="https://protonvpn.com">–°–∫–∞—á–∞—Ç—å Proton VPN</a>"""
        }
        return fallbacks.get(self.category, fallbacks["–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"])
    
    async def get_image(self):
        """–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏—é"""
        queries_by_category = {
            "–Ω–æ–≤–∏–Ω–∫–∏": ["new technology release", "ai innovation", "tech announcement"],
            "–ø—Ä–∏—ë–º—ã": ["workflow automation", "productivity tips", "creative process"],
            "–∏–Ω—Å–∞–π–¥—ã": ["secret feature", "hidden gem technology", "exclusive access"],
            "–º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è": ["online income", "side hustle", "passive income laptop"],
            "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã": ["creative tools interface", "ai dashboard", "digital workspace"],
            "–¥–æ—Å—Ç—É–ø": ["global internet", "vpn connection", "digital freedom"]
        }
        queries = queries_by_category.get(self.category, ["ai art generation", "neural network"])
        query = random.choice(queries)
        
        for attempt in range(2):
            try:
                img = requests.get(
                    "https://api.unsplash.com/photos/random",
                    params={"query": query, "orientation": "landscape", "client_id": self.unsplash_key},
                    timeout=10
                ).json()
                url = img["urls"]["regular"]
                if url.endswith(('.jpg', '.jpeg', '.png', '.webp')):
                    return url
                else:
                    return url.split('?')[0] + "?auto=compress&cs=tinysrgb&w=1200&h=630&fit=crop"
            except:
                continue
        
        fallbacks = [
            "https://images.unsplash.com/photo-1677234558153-bf5ce094bad4?auto=compress&cs=tinysrgb&w=1200&h=630&fit=crop",
            "https://images.unsplash.com/photo-1682978256082-0b97a6a7f77e?auto=compress&cs=tinysrgb&w=1200&h=630&fit=crop",
            "https://images.unsplash.com/photo-1679733087885-28eb46657ffb?auto=compress&cs=tinysrgb&w=1200&h=630&fit=crop"
        ]
        return random.choice(fallbacks)
    
    async def send_to_user(self):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å—Ç –≤–∞–º –≤ –ª–∏—á–∫—É"""
        print(f"üöÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ [{self.category}]: {datetime.now()}")
        
        try:
            reddit_posts = await self.fetch_reddit_posts()
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(reddit_posts)} –∫–µ–π—Å–æ–≤")
            
            text = await self.generate_text(reddit_posts)
            print(f"‚úÖ –¢–µ–∫—Å—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω ({len(text)} —Å–∏–º–≤–æ–ª–æ–≤)")
            
            image_url = await self.get_image()
            print(f"üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞: {image_url[:70]}")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
            instruction = f"\n\nüëâ <b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</b>\n1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—ã—à–µ\n2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≤–∞—à –∫–∞–Ω–∞–ª\n3. –ù–∞–∂–º–∏—Ç–µ ¬´–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç¬ª\n4. –í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç + –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —ç—Ç—É –∫–∞—Ä—Ç–∏–Ω–∫—É –≤—Ä—É—á–Ω—É—é\n5. –û–ø—É–±–ª–∏–∫—É–π—Ç–µ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É 10:00‚Äì15:00"
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É —Å —Ç–µ–∫—Å—Ç–æ–º –≤ –ø–æ–¥–ø–∏—Å–∏
            await self.bot.send_photo(
                chat_id=self.user_id,
                photo=image_url,
                caption=text + instruction,
                parse_mode="HTML"
            )
            print(f"‚úÖ –ü–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–∞–º –≤ –ª–∏—á–∫—É (user_id: {self.user_id})")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
            print(traceback.format_exc())
            # –§–æ–ª–±—ç–∫: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            try:
                await self.bot.send_message(
                    chat_id=self.user_id,
                    text="‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ–ª–±—ç–∫:\n\n" + self._fallback_post(),
                    parse_mode="HTML"
                )
                print("‚úÖ –§–æ–ª–±—ç–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ª–∏—á–∫—É")
            except Exception as e2:
                print(f"‚ùå –ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e2}")

if __name__ == "__main__":
    agent = FreeAITechAgent()
    asyncio.run(agent.send_to_user())
