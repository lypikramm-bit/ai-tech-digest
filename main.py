import os
import requests
import asyncio
from datetime import datetime
from telegram import Bot
import random
import traceback

class FreeAITechAgent:
    def __init__(self):
        self.bot = Bot(token=os.environ["TELEGRAM_BOT_TOKEN"])
        self.channel_id = os.environ["TELEGRAM_CHANNEL_ID"]
        self.unsplash_key = os.environ["UNSPLASH_ACCESS_KEY"]
    
    async def generate_text(self):
        topics = [
            "üî• –¢–û–ü-3 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏—Ç",
            "üí∏ –ö–∞–∫ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å $500/–º–µ—Å –Ω–∞ –ø—Ä–æ–º–ø—Ç–∞—Ö –¥–ª—è Midjourney",
            "ü§ñ 5 –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (–∫–æ–ø–∏—Ä—É–π –∏ –≤—Å—Ç–∞–≤–ª—è–π)",
            "‚ö° –õ–∞–π—Ñ—Ö–∞–∫: –∫–∞–∫ –±–µ—Å–ø–ª–∞—Ç–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 100 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/–¥–µ–Ω—å",
            "üé® –ù–µ–π—Ä–æ—Å–µ—Ç–∏ –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤: 3 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–º–µ–Ω—è—Ç –§–æ—Ç–æ—à–æ–ø",
            "üí∞ –ó–∞—Ä–∞–±–æ—Ç–æ–∫ –Ω–∞ –ò–ò: 3 —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–µ–π—Å–∞ –±–µ–∑ –≤–ª–æ–∂–µ–Ω–∏–π",
            "üöÄ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏ ChatGPT, –∫–æ—Ç–æ—Ä—ã–µ –ª—É—á—à–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞",
            "üñºÔ∏è –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –≤–∏—Ä—É—Å–Ω—ã–π –º–µ–º –∑–∞ 60 —Å–µ–∫—É–Ω–¥ —Å –ø–æ–º–æ—â—å—é –ò–ò",
            "üìà –¢–û–ü-5 –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –±–∏–∑–Ω–µ—Å–∞ —á–µ—Ä–µ–∑ –ò–ò",
            "üÜì –°–∫—Ä—ã—Ç—ã–µ —Ñ–∏—á–∏ Midjourney, –æ –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–ª—á–∞—Ç –≤—Å–µ –≥—É—Ä—É"
        ]
        topic = random.choice(topics)
        
        prompt = f"""–¢—ã ‚Äî —Ç–æ–ø–æ–≤—ã–π SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ—Å—Ç –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞ –ø—Ä–æ –ò–ò (–∞—É–¥–∏—Ç–æ—Ä–∏—è 20-45 –ª–µ—Ç).

–¢–µ–º–∞ –ø–æ—Å—Ç–∞: {topic}

–ü—Ä–∞–≤–∏–ª–∞ –°–¢–†–û–ì–û:
1. –î–ª–∏–Ω–∞: 120-200 —Å–ª–æ–≤. –ù–ò–ö–ê–ö–û–ô –í–û–î–´. –ö–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ = —Ü–µ–Ω–Ω–æ—Å—Ç—å.
2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
   - –¶–µ–ø–ª—è—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å üî•/üí∏/‚ö°/ü§ñ —ç–º–æ–¥–∑–∏
   - 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ‚Äî —Å—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã/–±–æ–ª–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
   - 3-4 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—É–Ω–∫—Ç–∞ —Å –ª–∞–π—Ñ—Ö–∞–∫–∞–º–∏/—Å–µ—Ä–≤–∏—Å–∞–º–∏/–ø—Ä–æ–º–ø—Ç–∞–º–∏
   - –í –∫–æ–Ω—Ü–µ: –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é + —Å—Å—ã–ª–∫–∞ –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å
3. –°—Ç–∏–ª—å:
   - –ö–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã (–º–∞–∫—Å 1 —Å—Ç—Ä–æ–∫–∞)
   - –≠–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ (–Ω–µ –ø–µ—Ä–µ–±–æ—Ä—â–∏—Ç—å)
   - –ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ —á–µ—Ä–µ–∑ **—Å–ª–æ–≤–æ**
   - –ö—É—Ä—Å–∏–≤ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ _—Å–ª–æ–≤–æ_
   - –°—Å—ã–ª–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: [–Ω–∞–∑–≤–∞–Ω–∏–µ](https://—Å—Å—ã–ª–∫–∞)
4. –¢–µ–º–∞—Ç–∏–∫–∞: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –∑–∞—Ä–∞–±–æ—Ç–æ–∫ –Ω–∞ –ò–ò, –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤, –ª–∞–π—Ñ—Ö–∞–∫–∏, –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã.
5. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π: *, _, [, ], (, ) –≤ —Ç–µ–∫—Å—Ç–µ –∫—Ä–æ–º–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –≠–∫—Ä–∞–Ω–∏—Ä—É–π —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã."""

        print(f"üß† –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø–æ—Å—Ç –Ω–∞ —Ç–µ–º—É: {topic}")
        
        response = requests.post(
            "https://api.groq.com/openai/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {os.environ['GROQ_API_KEY']}",
                "Content-Type": "application/json"
            },
            json={
                "model": "llama-3.1-8b-instant",
                "messages": [{"role": "user", "content": prompt}],
                "max_tokens": 400,
                "temperature": 0.9
            },
            timeout=30
        )
        
        if response.status_code != 200:
            print(f"‚ùå –û—à–∏–±–∫–∞ Groq: {response.status_code} ‚Äî {response.text[:200]}")
            # –§–æ–ª–±—ç–∫: –≥–æ—Ç–æ–≤—ã–π –ø–æ—Å—Ç –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏
            return """üî• **Midjourney –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏? –õ–µ–≥–∞–ª—å–Ω–æ!**

–•–æ—á–µ—à—å –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–µ–∑ $10/–º–µ—Å?

‚úÖ **Leonardo.ai** ‚Äî 150 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
‚úÖ **Playground AI** ‚Äî 1000 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/–¥–µ–Ω—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ
‚úÖ **Bing Image Creator** ‚Äî –±–µ–∑–ª–∏–º–∏—Ç–Ω–æ —á–µ—Ä–µ–∑ Microsoft Rewards

–õ–∞–π—Ñ—Ö–∞–∫: —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –≤–µ–∑–¥–µ —Å—Ä–∞–∑—É ‚Äî –Ω–∞–±–µ—Ä—ë—à—å 2000+ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –≤ –º–µ—Å—è—Ü üöÄ

üëâ [Leonardo.ai](https://leonardo.ai)"""
        
        text = response.json()["choices"][0]["message"]["content"]
        return self._escape_markdown(text)
    
    def _escape_markdown(self, text):
        """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ Markdown –≤ Telegram"""
        escape_chars = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!']
        for char in escape_chars:
            text = text.replace(char, '\\' + char)
        return text.replace('\\*\\*', '**').replace('\\_\\_', '__').replace('\\`\\`\\`', '```')
    
    async def get_image(self):
        queries = [
            "ai generated art", "digital creativity", "neural network art",
            "money technology", "side hustle", "creative coding",
            "prompt engineering", "digital tools", "future of work"
        ]
        query = random.choice(queries)
        
        try:
            img = requests.get(
                "https://api.unsplash.com/photos/random",
                params={"query": query, "orientation": "landscape", "client_id": self.unsplash_key},
                timeout=10
            ).json()
            return img["urls"]["regular"]
        except:
            return "https://picsum.photos/1200/630"
    
    async def publish(self):
        print(f"üöÄ –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞: {datetime.now()}")
        
        try:
            text = await self.generate_text()
            print(f"‚úÖ –¢–µ–∫—Å—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω")
            
            image_url = await self.get_image()
            print(f"üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å—Ç —Å –ø—Ä–æ—Å—Ç—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            await self.bot.send_photo(
                chat_id=self.channel_id,
                photo=image_url,
                caption=text[:1024],
                parse_mode="MarkdownV2"
            )
            print(f"‚úÖ –ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ {self.channel_id}")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            print(traceback.format_exc())
            # –§–æ–ª–±—ç–∫: –ø—É–±–ª–∏–∫—É–µ–º –±–µ–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏
            await self.bot.send_message(
                chat_id=self.channel_id,
                text=text[:4096],
                parse_mode=None
            )
            print("‚úÖ –ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")

if __name__ == "__main__":
    asyncio.run(FreeAITechAgent().publish())
